
var mongodb = require("mongodb");

function MongoDB(){
    var server = new mongodb.Server('localhost',27017,{auto_reconnect:true}, 10);

    var db = new mongodb.Db("warm",server);


    var self = this;
    db.open(function(err,db){
        if(err){
            console.log(err);
        }
        if(!err){
            console.log("we are connected!");
            db.collection('torrents', function(err,collection){
                self.collection = collection;
                insertTorrent(12445);
                getTopTorrent(5);
            });
        }
    });

    function insertTorrent(info_hash){
        self.collection.update({'info_hash': info_hash}, {$inc:{'num': 1}} ,{upsert:true, w: 1},function(err,result){
            if(err) throw err;
        });

    }
    function getTopTorrent(num, callback){
        self.collection.find({
                'is_read': {$ne: 1}
            },
            {
                sort:{
                    'num': -1
                },
                limit: num
            }).toArray(function(err, docs) {
                for(var i = 0; i < docs.length; i++){
                    collection.update({'info_hash': docs[i]['info_hash']}, {$set:{'is_read': 1}});
                }
                console.log(docs);
                callback && callback(docs);
            });
    }
    this.insertTorrent = insertTorrent;
    this.getTopTorrent = getTopTorrent;
}

exports = MongoDB;