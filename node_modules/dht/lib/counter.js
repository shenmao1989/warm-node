//服务端存储
//exports
var util = require('./util');
var http = require('http');
var url=require('url');

function Counter(delay){
    console.log('counter init');
    if(!delay){
        delay = 30 * 1000;
    }

    var self = this;
    this.dataQueue = {
        'counter': {
            'send':0,
            'get_peers': 0,
            'find_node': 0,
            'ping': 0,
            'announce_peer': 0
        },
        'hash': []
    };

    this.recordHash = function(hash){
        self.dataQueue.hash.push(hash);
    }
    this.recordCount = function(type){
        if(self.dataQueue[type]){
            self.dataQueue[type]++;
        }else{
            self.dataQueue[type] = 1;
        }
    }
    setInterval(function(){
        console.log('send');
        _sendHash(self.dataQueue.hash);
        self.dataQueue.hash = [];

        for (var type in self.dataQueue.hash.counter) {
            _sendCounter(type, self.dataQueue.hash.counter[type]);
            self.dataQueue.hash.counter[type] = 0;
        }
    }, delay);

    function _sendCounter(type, num, callback){
        http.get(url.parse("http://shenmaohelp.sinaapp.com/?m=Dht&a=counter&type=" + type + "&num=" + num), function(res) {
            util.debug("counter: " + res.statusCode);
            callback && callback();
        }).on('error', function(e) {
                util.debug("counter: " + e.message);
        });
    }
    function _sendHash(hashes, callback){
        var hash = hashes.join(',');
        http.get(url.parse("http://shenmaohelp.sinaapp.com/?m=Dht&a=addHash&info_hash=" + hash), function(res) {
            util.debug("hash: " + res.statusCode);
            callback && callback();
        }).on('error', function(e) {
                util.debug("hash: " + e.message);
        });
    }
}
exports.Counter = Counter;